<!DOCTYPE html>
<html>
<head>
    <title>Fire Watch Demo</title>
    <style>
        body{
            background-color:rgb(48,48,48);
            color:gray;
            font-family:Helvetica,Arial,sans-serif;
            font-size:12px;
        }
        h4 {
            font-weight:normal;
        }
        h1{
            font-weight:normal;
        }
        h3{
            font-weight:normal;
        }
        #cs{
            width:100%;
            background-color:black;
            color:white;
        }
        #ipt{
            outline:none;
            border:1px solid black;
            background:gray;
        }
    </style>
</head>
<body>
    <h1>Fire Watch Demo</h1>
    <h3>Please Choose a Folder:  <input type="text" value="/Users/kamisama/vimfiles" id="ipt"> <button onclick="init()">Start Watch</button></input></h3>
    <h3>console.log:</h3>
    <div id="cs"></div>
    <H3>The wait operation...</H3>
</body>
<script>
var fs = require('fs'),
util = require('util'),
//要监控的文件路径
path = '/Users/kamisama/vimfiles';
var PathWatcher = require('pathwatcher');
var watcher1 = null;
var DirArray = [];
var temp = [];
var FileArray = [];
var initArray = [];
var tempTime = 0;


function DateToMilliseconds(date) {
    var a=date.split(":");
    return times = a[0]*60*60*1000+a[1]*60*1000+a[2]*1000;
}

function init() {
    path = document.getElementById('ipt').value;
    console.log("%cStart watch the Folder:"+path+"    ....","color:red");
    logs("Start watch the Folder:"+path+"    ....");
    watcher(path);
    DirArray = scanFolder(path);
    for (var i=0;i<DirArray.length;i++) {
        watcher(DirArray[i]);
    }

}


function watcher(pathorfile) {
    watcher1 = PathWatcher.watch(pathorfile, function(event) {
        logs(event);
        temp = DirArray;
        DirArray = scanFolder(path);
        initArray = scanFolder(path);
        var type =0;
        if (temp.length == DirArray.length ) {
            type =1;
        }else if(temp.length < DirArray.length) {
            type =2;
        }else if (temp.length > DirArray.length) {
            type =3;
        }

        if (type ==1 ||type ==2) {
            for (var i=0;i<DirArray.length;i++) {
                for (var j=0;j<temp.length;j++) {
                    if (DirArray[i] == temp[j]){
                        delete initArray[i];
                    }
                }
            }
        }

        if(type == 3) {
            initArray = temp;
            for (var i=0;i<temp.length;i++) {
                for (var j=0;j<DirArray.length;j++) {
                    if (temp[i] == DirArray[j]){
                        delete initArray[i];
                    }
                }
            }
        }


        var addFile="";
        for (var i= 0;i<initArray.length;i++) {
            if (initArray[i]!=""&&initArray[i]!=undefined){
                addFile =initArray[i];
            }
        }

        if (addFile!="" && addFile != undefined){
            var date =new Date();
            switch(type){
                case 1:
                console.log("rename");
                logs("rename");
                console.log(addFile+"   "+date.toLocaleTimeString());
                logs(addFile+"   "+date.toLocaleTimeString());
                watcher(addFile);
                break;
                case 2:
                console.log("Add Folder");
                logs("Add Folder");
                console.log(addFile+"   "+date.toLocaleTimeString());
                logs(addFile+"   "+date.toLocaleTimeString());
                watcher(addFile);
                break;
                case 3:
                console.log("delete Folder");
                logs("delete Folder");
                console.log(addFile+"   "+date.toLocaleTimeString());
                logs(addFile+"   "+date.toLocaleTimeString());
                break;
            }
        }
});
}

function scanFolder(path){
    var fileList = [],
    folderList = [],
    walk = function(path, fileList, folderList) {
        files = fs.readdirSync(path);
        files.forEach(function(item) {
            var tmpPath = path + '/' + item,
            stats = fs.statSync(tmpPath);
            if (stats.isDirectory()) {
                walk(tmpPath, fileList, folderList);
                if (path != tmpPath) {
                    folderList.push(tmpPath);
                }
            }
        });
    };
    walk(path, fileList, folderList);
    return folderList;
}



function logs(result){
    var cs = document.getElementById('cs');
    var elei = document.createElement('h4');
    elei.innerHTML = result;
    elei.style.color="rgb('170,170,170')";
    elei.style.marginTop ="-10px";
    elei.style.paddingTop ="-10px";
    cs.appendChild(elei);
}


</script>
</html>
